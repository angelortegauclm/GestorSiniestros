AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Backend deployment

Parameters:
  DBUsername:
    Type: String
    Default: admingestor
  DBPassword:
    Type: String
    Default: admingestor
    NoEcho: true
  LabRoleArn:
    Type: String
    Default: arn:aws:iam::851725537191:role/LabRole
  MyPublicIP:
    Type: String
    Description: IP pública
    AllowedPattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}$"
    ConstraintDescription: Debe ser una IP válida (x.x.x.x)
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC donde se desplegarán los recursos
  PrivateSubnet1:
    Type: AWS::EC2::Subnet::Id
    Description: Primera subnet privada
  PrivateSubnet2:
    Type: AWS::EC2::Subnet::Id
    Description: Segunda subnet privada

Resources:
  BackendSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "SecurityGroup"
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: !Sub "${MyPublicIP}/32"  # Permitir acceso desde la IP pública del usuario

  BackendDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnets por defecto para RDS
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  # Base de datos RDS PostgreSQL
  BackendDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: backenddb
      Engine: postgres
      EngineVersion: "18.1"
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      DBInstanceClass: db.t3.micro
      AllocatedStorage: 20
      PubliclyAccessible: true
      DBSubnetGroupName: !Ref BackendDBSubnetGroup
      VPCSecurityGroups:
        - !Ref BackendSecurityGroup

  # Colas SQS
  Queue1:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: queue-1

  Queue2:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: queue-2

  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: "'GET,POST,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: common-layer
      Description: "Librerías comunes psycopg2-binary y boto3"
      ContentUri: ../src/backend/layers/common
      CompatibleRuntimes:
        - python3.12

  FPDFLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: fpdf-layer
      Description: "Librerías fpdf y fpdf2"
      ContentUri: ../src/backend/layers/fpdf
      CompatibleRuntimes:
        - python3.12

  # Lambda 1
  backendAPI:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: backendAPI
      Runtime: python3.12
      Handler: lambda1.lambda_handler
      CodeUri: ../src/backend/API
      Layers:
        - !Ref CommonLayer
      Role: !Ref LabRoleArn
      Environment:
        Variables:
          QUEUE_URL: !Ref Queue1
          DB_HOST: !GetAtt BackendDB.Endpoint.Address
          DB_PORT: !Sub "${BackendDB.Endpoint.Port}"
          DB_NAME: postgres
          DB_USER: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
      Events:
        CrearPost:
          Type: Api
          Properties:
            Path: /crear
            Method: post
            RestApiId: !Ref ApiGatewayApi
        ConsultarGet:
          Type: Api
          Properties:
            Path: /consultar
            Method: get
            RestApiId: !Ref ApiGatewayApi
      VpcConfig:
        SecurityGroupIds:
          - !Ref BackendSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2

  # Lambda 2 (vacía) con trigger SQS1
  BackendCalculos:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: BackendCalculos
      Runtime: python3.12
      Handler: lambda2.lambda_handler
      CodeUri: ../src/backend/Calculos
      Layers:
        - !Ref CommonLayer
      Policies:                        # permisos para escribir en la siguiente cola
        - SQSSendMessagePolicy:
            #QueueName: !GetAtt Queue2.QueueName
            QueueName: queue-2
      Environment:                  
        Variables:
          DB_HOST: !GetAtt BackendDB.Endpoint.Address
          DB_PORT: !Sub "${BackendDB.Endpoint.Port}"
          DB_NAME: postgres
          DB_USER: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          QUEUE_1_URL: !Ref Queue1 
          QUEUE_2_URL: !Ref Queue2
      Role: !Ref LabRoleArn
      Events:
        QueueTrigger:
          Type: SQS
          Properties:
            Queue: !GetAtt Queue1.Arn
            BatchSize: 1               # Procesa los mensajes de uno en uno para evitar errores
      VpcConfig:
        SecurityGroupIds:
          - !Ref BackendSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2

  # Lambda 3 con trigger SQS2
  BackendGeneracionDocumentos:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: BackendDocumentos
      Runtime: python3.12
      CodeUri: ../src/backend/Documentos
      Layers:
        - !Ref CommonLayer
        - !Ref FPDFLayer
      Handler: lambda3.lambda_handler
      Role: !Ref LabRoleArn
      Environment:                  
        Variables:
          BUCKET_NAME: !Sub "facturas-gestorsiniestros-${AWS::AccountId}"
          DB_HOST: !GetAtt BackendDB.Endpoint.Address
          DB_PORT: !Sub "${BackendDB.Endpoint.Port}"
          DB_NAME: postgres
          DB_USER: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          QUEUE_2_URL: !Ref Queue2
      Policies:
        - S3WritePolicy:
            BucketName: !Sub "facturas-gestorsiniestros-${AWS::AccountId}"
      Events:
        QueueTrigger:
          Type: SQS
          Properties:
            Queue: !GetAtt Queue2.Arn
      VpcConfig:
        SecurityGroupIds:
          - !Ref BackendSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2